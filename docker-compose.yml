# docker-compose.yml - APP_ENV-driven configuration
# This file uses the APP_ENV environment variable to dynamically configure services
# Usage: Set APP_ENV (via .envrc) then run: just up

services:
  app:
    container_name: cleanstack-app-${APP_ENV}
    build: .
    ports:
      - '${APP_PORT}:4224'
    environment:
      - APP_ENV=${APP_ENV}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./config_default.toml:/config_default.toml:ro
      - ./config_${APP_ENV}.toml:/config_${APP_ENV}.toml:ro

  db:
    container_name: cleanstack-db-${APP_ENV}
    image: postgres:18.1-alpine3.23
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: cleanstack_${APP_ENV}
    ports:
      - '127.0.0.1:${DB_PORT}:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U user -d cleanstack_${APP_ENV}']
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
